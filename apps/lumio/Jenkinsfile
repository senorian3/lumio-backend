def app
pipeline {
    agent any
    environment {
        ENV_TYPE = "production"
        PORT = 4121
        NAMESPACE = "lumio-su"
        REGISTRY_HOSTNAME = "senorian3"
        PROJECT = "lumio-back-end"
        SERVICE = "lumio"  // Явно указано, что этот Jenkinsfile только для lumio
        REGISTRY = "registry.hub.docker.com"
        DEPLOYMENT_NAME = "lumio-back-end-deployment"
        IMAGE_NAME = "${env.BUILD_ID}_${env.ENV_TYPE}_${env.GIT_COMMIT}"
        DOCKER_BUILD_NAME = "${env.REGISTRY_HOSTNAME}/${env.PROJECT}:${env.IMAGE_NAME}"
    }

    stages {
        stage('Clone repository') {
            steps {
                checkout scm
            }
        }
        
        stage('Debug info') {
            steps {
                sh '''
                    echo "=== Jenkinsfile for LUMIO service only ==="
                    echo "Service: ${SERVICE}"
                    echo "Node version: $(node --version)"
                    echo "NPM version: $(npm --version)"
                    echo "Yarn version: $(yarn --version)"
                    echo "Current directory: $(pwd)"
                    ls -la
                '''
            }
        }
        
        stage('Setup and Run Unit Tests') {
            steps {
                script {
                    sh '''
                       # Убедимся, что Node.js доступен
                       echo "Using Node.js: $(node --version)"
                       
                       # Install dependencies for lumio service
                       yarn install
                       
                       # Generate Prisma client for test environment for lumio only
                       echo "Generating Prisma client for lumio test environment..."
                       yarn prisma:generate:lumio:test
                       
                       # Apply Prisma migrations for test environment for lumio only
                       echo "Applying Prisma migrations for lumio test environment..."
                       yarn prisma:test:lumio
                       
                       # Run unit tests for lumio service only
                       echo "Running unit tests for lumio service..."
                       yarn test:unit:lumio
                    '''
                }
            }
        }
        
        stage('Build docker image') {
            steps {
                echo "Build image started for lumio service..."
                script {
                    app = docker.build("${env.DOCKER_BUILD_NAME}", "--build-arg service=${env.SERVICE} --build-arg port=${env.PORT} -f ./apps/${env.SERVICE}/Dockerfile ./")
                }
                echo "Build image finished for lumio service..."
            }
        }
        
        stage('Push docker image') {
            steps {
                echo "Push image started for lumio service..."
                script {
                    docker.withRegistry("https://${env.REGISTRY}", 'lumio-su') {
                        app.push("${env.IMAGE_NAME}")
                    }
                }
                echo "Push image finished for lumio service..."
            }
        }
        
        stage('Delete image local') {
            steps {
                script {
                    sh "docker rmi -f ${env.DOCKER_BUILD_NAME}"
                }
            }
        }
        
        stage('Preparing deployment') {
            steps {
                echo "Preparing deployment for lumio service..."
                sh 'ls -ltr'
                sh 'pwd'
                sh "chmod +x ./apps/${env.SERVICE}/preparingDeploy.sh"
                sh "./apps/${env.SERVICE}/preparingDeploy.sh ${env.REGISTRY_HOSTNAME} ${env.PROJECT} ${env.IMAGE_NAME} ${env.DEPLOYMENT_NAME} ${env.PORT} ${env.NAMESPACE}"
                sh "cat ./apps/${env.SERVICE}/deployment.yaml"
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                withKubeConfig([credentialsId: 'prod-kubernetes']) {
                    sh "kubectl apply -f ./apps/${env.SERVICE}/deployment.yaml"
                    sh "kubectl rollout status deployment/${env.DEPLOYMENT_NAME} --namespace=${env.NAMESPACE}"
                    sh "kubectl get services -o wide"
                }
            }
        }
    }
    
    post {
        success {
            echo "Lumio service pipeline completed successfully!"
        }
        failure {
            echo "Lumio service pipeline failed!"
        }
    }
}