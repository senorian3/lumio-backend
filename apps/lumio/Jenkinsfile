def app

pipeline {
    agent any
    environment {
        ENV_TYPE = "production"
        PORT = 4121
        NAMESPACE = "lumio-su"
        REGISTRY_HOSTNAME = "senorian3"
        PROJECT = "lumio-back-end"
        SERVICE = "lumio"
        REGISTRY = "registry.hub.docker.com"
        DEPLOYMENT_NAME = "lumio-back-end-deployment"
        IMAGE_NAME = "${env.BUILD_ID}_${env.ENV_TYPE}_${env.GIT_COMMIT}"
        DOCKER_BUILD_NAME = "${env.REGISTRY_HOSTNAME}/${env.PROJECT}:${env.IMAGE_NAME}"
    }

    stages {
        stage('Clone repository') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup environment') {
            steps {
                script {
                    sh '''
                       echo "=== Setting up environment ==="
                       
                       export NVM_DIR="$HOME/.nvm"
                       [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                       
                       nvm install 20.17.0
                       nvm use 20.17.0
                       
                       echo "Node version: $(node --version)"
                       echo "NPM version: $(npm --version)"
                       
                       yarn install
                       
                       echo "✅ Environment setup completed"
                    '''
                }
            }
        }
        
        stage('Unit tests') {
            steps {
                script {
                    sh '''
                        echo "=== Starting unit tests ==="
                        
                        echo "Generating Prisma Client..."
                        npx prisma generate --schema apps/lumio/src/prisma/schema.prisma
                        
                        echo "Running unit tests..."
                        yarn test:unit:lumio
                        
                        if [ $? -eq 0 ]; then
                            echo "✅ Unit tests passed"
                        else
                            echo "❌ Unit tests failed"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('Build docker image') {
            steps {
                script {
                    echo "Building docker image..."
                    app = docker.build(
                        "${env.DOCKER_BUILD_NAME}",
                        "--build-arg service=${env.SERVICE} --build-arg port=${env.PORT} -f ./apps/${env.SERVICE}/Dockerfile ./"
                    )
                }
            }
        }
        
        stage('Push docker image') {
            steps {
                script {
                    echo "Pushing docker image to registry..."
                    docker.withRegistry("https://${env.REGISTRY}", 'lumio-su') {
                        app.push("${env.IMAGE_NAME}")
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    echo "Cleaning up local docker image..."
                    sh "docker rmi -f ${env.DOCKER_BUILD_NAME} || true"
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "=== Deploying to Kubernetes ==="
                    
                    echo "1. Preparing deployment..."
                    sh 'ls -ltr'
                    sh 'pwd'
                    sh "chmod +x ./apps/${env.SERVICE}/preparingDeploy.sh"
                    sh "./apps/${env.SERVICE}/preparingDeploy.sh ${env.REGISTRY_HOSTNAME} ${env.PROJECT} ${env.IMAGE_NAME} ${env.DEPLOYMENT_NAME} ${env.PORT} ${env.NAMESPACE}"
                    
                    echo "2. Checking deployment.yaml..."
                    sh "cat ./apps/${env.SERVICE}/deployment.yaml"
                    
                    echo "3. Applying deployment..."
                    withKubeConfig([credentialsId: 'prod-kubernetes']) {
                        sh "kubectl apply -f ./apps/${env.SERVICE}/deployment.yaml"
                        sh "kubectl rollout status deployment/${env.DEPLOYMENT_NAME} --namespace=${env.NAMESPACE} --timeout=300s"
                        sh "kubectl get services -o wide --namespace=${env.NAMESPACE}"
                        sh "kubectl get pods --namespace=${env.NAMESPACE} | grep ${env.DEPLOYMENT_NAME}"
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "=== Pipeline finished ==="
            echo "Build result: ${currentBuild.result}"
            echo "Build URL: ${env.BUILD_URL}"
            
            script {
                sh '''
                    echo "Cleaning up temporary files..."
                    rm -f .env.testing 2>/dev/null || true
                '''
            }
        }
        
        success {
            echo "✅ Pipeline completed successfully!"
        }
        
        failure {
            echo "❌ Pipeline failed!"
        }
    }
}