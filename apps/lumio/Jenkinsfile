def app
pipeline {
    agent any
    environment {
        ENV_TYPE = "production"
        PORT = 4121
        NAMESPACE = "lumio-su"
        REGISTRY_HOSTNAME = "senorian3"
        PROJECT = "lumio-back-end"
        SERVICE="lumio"
        REGISTRY = "registry.hub.docker.com"
        DEPLOYMENT_NAME = "lumio-back-end-deployment"
        IMAGE_NAME = "${env.BUILD_ID}_${env.ENV_TYPE}_${env.GIT_COMMIT}"
        DOCKER_BUILD_NAME = "${env.REGISTRY_HOSTNAME}/${env.PROJECT}:${env.IMAGE_NAME}"
    }

    stages {
        stage('Clone repository') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup environment and generate Prisma Client') {
            steps {
                script {
                    sh '''
                       echo "=== Setting up environment and generating Prisma Client ==="
                       
                       export NVM_DIR="$HOME/.nvm"
                       [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                       
                       nvm install 20.17.0
                       nvm use 20.17.0
                       
                       echo "Node version: $(node --version)"
                       echo "NPM version: $(npm --version)"
                       
                       yarn install
                       
                       npx prisma generate --schema apps/lumio/src/prisma/schema.prisma
                       
                       echo "✅ Environment setup and Prisma Client generation completed"
                    '''
                }
            }
        }
        
        stage('Unit tests') {
            steps {
                script {
                    sh '''
                       echo "Unit tests are not implemented yet. Skipping..." 
                    '''
                }
            }
        }
        
        stage('e2e tests') {
            steps {
                script {
                    sh '''
                        echo "=== Starting e2e tests ==="
                        export NVM_DIR="$HOME/.nvm"
                        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
                        nvm use 20.17.0

                        echo "Installing dependencies..."
                        yarn install

                        echo "Generating Prisma Client for test environment..."
                        yarn prisma:generate:lumio:test
                        
                        echo "Checking for Jenkins test environment file..."
                        
                        # Проверяем наличие файла с тестовыми переменными
                        if [ -f "jenkins-test-env" ]; then
                            echo "✓ Found jenkins-test-env file"
                            echo "Using jenkins-test-env for tests..."
                            
                            # Создаем .env.test на основе jenkins-test-env
                            cp jenkins-test-env .env.testing
                            
                            # Добавляем обязательные переменные если их нет
                            if ! grep -q "NODE_ENV" .env.testing; then
                                echo "NODE_ENV=testing" >> .env.testing
                            fi
                            if ! grep -q "PORT" .env.testing; then
                                echo "PORT=3000" >> .env.testing
                            fi
                            
                        else
                            echo "❌ ERROR: jenkins-test-env file not found!"
                            echo ""
                            echo "To fix this:"
                            echo "1. Create a file named 'jenkins-test-env' in the repository root"
                            echo "2. Use 'jenkins-test-env.example' as a template"
                            echo "3. Fill in actual test values"
                            echo ""
                            echo "Or contact Jenkins administrator"
                            exit 1
                        fi
                        
                        echo "Running e2e tests..."
                        
                        echo "1. Running auth e2e tests..."
                        if dotenv -e .env.testing -- jest --config apps/lumio/test/jest-e2e.json apps/lumio/test/e2e/auth/auth.e2e-spec.ts; then
                            echo "✅ Auth e2e tests passed"
                        else
                            echo "❌ Auth e2e tests failed"
                            echo "Test environment used:"
                            cat .env.testing | sed 's/.*SECRET.*/*** MASKED ***/' | sed 's/.*PASSWORD.*/*** MASKED ***/'
                            rm -f .env.testing
                            exit 1
                        fi
                        
                        echo "2. Running session e2e tests..."
                        if dotenv -e .env.testing -- jest --config apps/lumio/test/jest-e2e.json apps/lumio/test/e2e/session/session.e2e-spec.ts; then
                            echo "✅ Session e2e tests passed"
                        else
                            echo "❌ Session e2e tests failed"
                            rm -f .env.testing
                            exit 1
                        fi
                        
                        # Очищаем временные файлы
                        rm -f .env.testing
                        
                        echo "✅ All e2e tests completed successfully"
                    '''
                }
            }
        }
        
        stage('Build docker image') {
            steps {
                echo "Build image started..."
                script {
                    app = docker.build("${env.DOCKER_BUILD_NAME}", "--build-arg service=${env.SERVICE} --build-arg port=${env.PORT} -f ./apps/${env.SERVICE}/Dockerfile ./")
                }
                echo "Build image finished..."
            }
        }
        
        stage('Push docker image') {
            steps {
                echo "Push image started..."
                script {
                    docker.withRegistry("https://${env.REGISTRY}", 'lumio-su') {
                        app.push("${env.IMAGE_NAME}")
                    }
                }
                echo "Push image finished..."
            }
        }
        
        stage('Delete image local') {
            steps {
                script {
                    sh "docker rmi -f ${env.DOCKER_BUILD_NAME}"
                }
            }
        }
        
        stage('Preparing deployment') {
            steps {
                echo "Preparing started..."
                sh 'ls -ltr'
                sh 'pwd'
                sh "chmod +x ./apps/${env.SERVICE}/preparingDeploy.sh"
                sh "./apps/${env.SERVICE}/preparingDeploy.sh ${env.REGISTRY_HOSTNAME} ${env.PROJECT} ${env.IMAGE_NAME} ${env.DEPLOYMENT_NAME} ${env.PORT} ${env.NAMESPACE}"
                sh "cat ./apps/${env.SERVICE}/deployment.yaml"
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                withKubeConfig([credentialsId: 'prod-kubernetes']) {
                    sh "kubectl apply -f ./apps/${env.SERVICE}/deployment.yaml"
                    sh "kubectl rollout status deployment/${env.DEPLOYMENT_NAME} --namespace=${env.NAMESPACE}"
                    sh "kubectl get services -o wide"
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Очищаем временные файлы
                sh '''
                    echo "Cleaning up temporary files..."
                    if [ -f ".env.testing" ]; then
                        rm -f .env.testing
                    fi
                '''
            }
        }
    }
}