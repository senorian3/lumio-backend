pipeline {
    agent any
    
    environment {
        ENV_TYPE = "production"
        PORT = 4121
        NAMESPACE = "lumio-su"
        REGISTRY_HOSTNAME = "senorian3"
        PROJECT = "lumio-back-end"
        SERVICE = "lumio"
        REGISTRY = "registry.hub.docker.com"
        DEPLOYMENT_NAME = "lumio-back-end-deployment"
        IMAGE_NAME = "${env.BUILD_ID}_${env.ENV_TYPE}_${env.GIT_COMMIT}"
        DOCKER_BUILD_NAME = "${env.REGISTRY_HOSTNAME}/${env.PROJECT}:${env.IMAGE_NAME}"
        
        // –î–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        YARN_CACHE_DIR = "${WORKSPACE}/.yarn-cache"
        PRISMA_CACHE_DIR = "${WORKSPACE}/.prisma-cache"
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–º–∞–Ω–¥
        NODE_ENV = "production"
    }
    
    stages {
        stage('Clone repository') {
            steps {
                checkout scm
                
                sh '''
                    echo "=== Repository Info ==="
                    echo "Commit: ${GIT_COMMIT}"
                    echo "Branch: ${GIT_BRANCH}"
                    echo "Build: ${BUILD_NUMBER}"
                    echo "Workspace: ${WORKSPACE}"
                '''
            }
        }
        
        stage('Check prerequisites') {
            steps {
                script {
                    sh '''
                        echo "=== Quick prerequisites check ==="
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker
                        if ! docker --version > /dev/null 2>&1; then
                            echo "‚ùå FATAL: Docker not found or not working"
                            exit 1
                        fi
                        echo "‚úÖ Docker: $(docker --version | head -1)"
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º Node.js
                        if ! node --version > /dev/null 2>&1; then
                            echo "‚ùå FATAL: Node.js not found"
                            exit 1
                        fi
                        echo "‚úÖ Node.js: $(node --version)"
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Yarn –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        if ! yarn --version > /dev/null 2>&1; then
                            echo "Installing yarn globally..."
                            npm install -g yarn
                        fi
                        echo "‚úÖ Yarn: $(yarn --version)"
                        
                        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ts-loader –≥–ª–æ–±–∞–ª—å–Ω–æ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º
                        echo "Installing ts-loader globally..."
                        npm install -g ts-loader webpack webpack-cli
                        
                        echo "‚úÖ Prerequisites OK"
                    '''
                }
            }
        }
        
        stage('Clean and setup workspace') {
            steps {
                sh '''
                    echo "=== Cleaning workspace ==="
                    
                    # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±–∏–ª–¥—ã
                    find . -name "dist" -type d -prune -exec rm -rf {} + 2>/dev/null || true
                    find . -name ".next" -type d -prune -exec rm -rf {} + 2>/dev/null || true
                    find . -name "coverage" -type d -prune -exec rm -rf {} + 2>/dev/null || true
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º node_modules –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å
                    if [ -d "node_modules" ]; then
                        echo "Preserving existing node_modules..."
                    fi
                    
                    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫—ç—à–∞
                    mkdir -p ${YARN_CACHE_DIR}
                    mkdir -p ${PRISMA_CACHE_DIR}
                    
                    echo "‚úÖ Workspace cleaned and cache directories created"
                '''
            }
        }
        
        stage('Install dependencies with smart cache') {
            steps {
                script {
                    sh '''
                        echo "=== Installing dependencies ==="
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º package.json
                        if [ ! -f "package.json" ]; then
                            echo "‚ùå package.json not found!"
                            exit 1
                        fi
                        
                        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º @nestjs/cli –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º
                        echo "Installing @nestjs/cli..."
                        npm install @nestjs/cli --no-save || yarn add @nestjs/cli --dev
                        
                        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ts-loader –∫–∞–∫ dev dependency
                        echo "Installing ts-loader..."
                        yarn add ts-loader -D --ignore-engines || npm install ts-loader --save-dev
                        
                        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
                        echo "Installing project dependencies..."
                        yarn install --frozen-lockfile --prefer-offline --network-timeout 600000 --ignore-engines || {
                            echo "‚ùå Failed to install dependencies"
                            exit 1
                        }
                        
                        echo "‚úÖ Dependencies installed"
                    '''
                }
            }
        }
        
        stage('Code quality checks') {
            steps {
                script {
                    sh '''
                        echo "=== Running code quality checks ==="
                        
                        # –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–∏–Ω–≥
                        echo "Running ESLint..."
                        yarn lint 2>/dev/null || {
                            echo "‚ö†Ô∏è ESLint found issues or not configured"
                        }
                        
                        echo "‚úÖ Code quality checks completed"
                    '''
                }
            }
        }
        
        stage('Build application') {
            steps {
                script {
                    sh '''
                        echo "=== Building application ==="
                        
                        # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å
                        echo "Building ${SERVICE} service..."
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
                        ENV_FILE="apps/${SERVICE}/.env.${SERVICE}.${ENV_TYPE}"
                        if [ ! -f "${ENV_FILE}" ]; then
                            echo "‚ö†Ô∏è Environment file not found: ${ENV_FILE}"
                            echo "Using development environment file..."
                            ENV_FILE="apps/${SERVICE}/.env.${SERVICE}.development"
                        fi
                        
                        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç
                        echo "Generating Prisma client..."
                        if [ "${SERVICE}" = "lumio" ]; then
                            yarn prisma:generate:lumio 2>/dev/null || {
                                echo "‚ùå Failed to generate Prisma client"
                                exit 1
                            }
                        elif [ "${SERVICE}" = "files" ]; then
                            yarn prisma:generate:files 2>/dev/null || {
                                echo "‚ùå Failed to generate Prisma client"
                                exit 1
                            }
                        fi
                        
                        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–±–æ—Ä–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º npx —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º
                        echo "Building NestJS application using direct webpack..."
                        
                        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–∏–ª–¥–∞ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                        mkdir -p dist
                        
                        # –ò—Å–ø–æ–ª—å–∑—É–µ–º nest –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ npx
                        echo "Running: npx nest build ${SERVICE}"
                        npx nest build ${SERVICE} --verbose || {
                            echo "‚ùå Failed to build with nest command"
                            
                            # –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ webpack
                            echo "Trying alternative build method..."
                            if [ -f "node_modules/.bin/nest" ]; then
                                ./node_modules/.bin/nest build ${SERVICE} --webpack --webpackPath webpack.config.js || {
                                    echo "‚ùå Alternative build also failed"
                                    exit 1
                                }
                            else
                                echo "‚ùå Nest CLI not found in node_modules"
                                exit 1
                            fi
                        }
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∏–ª–¥–∞
                        if [ ! -d "dist/apps/${SERVICE}" ]; then
                            echo "‚ùå Build output not found at dist/apps/${SERVICE}"
                            echo "Contents of dist directory:"
                            ls -la dist/ 2>/dev/null || true
                            exit 1
                        fi
                        
                        echo "‚úÖ Application built successfully"
                        echo "Build output size:"
                        du -sh dist/apps/${SERVICE}
                    '''
                }
            }
        }
        
        stage('Run tests') {
            steps {
                script {
                    sh '''
                        echo "=== Running tests ==="
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
                        TEST_ENV_FILE="apps/${SERVICE}/.env.${SERVICE}.testing"
                        if [ ! -f "${TEST_ENV_FILE}" ]; then
                            echo "‚ö†Ô∏è Test environment file not found: ${TEST_ENV_FILE}"
                            echo "Skipping tests..."
                        else
                            # –ó–∞–ø—É—Å–∫–∞–µ–º unit —Ç–µ—Å—Ç—ã
                            echo "Running unit tests for ${SERVICE}..."
                            
                            if [ "${SERVICE}" = "lumio" ]; then
                                yarn test:unit:lumio --passWithNoTests || {
                                    echo "‚ö†Ô∏è Unit tests failed or no tests found"
                                }
                            else
                                yarn test:unit --passWithNoTests || {
                                    echo "‚ö†Ô∏è Unit tests failed or no tests found"
                                }
                            fi
                        fi
                        
                        echo "‚úÖ Tests completed"
                    '''
                }
            }
        }
        
        stage('Build Docker image') {
            steps {
                script {
                    echo "=== Building Docker image ==="
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Dockerfile
                    def dockerfile = "./apps/${SERVICE}/Dockerfile"
                    if (!fileExists(dockerfile)) {
                        error "‚ùå Dockerfile not found: ${dockerfile}"
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ package.json
                    def packageJson = readJSON file: 'package.json'
                    def version = packageJson.version ?: '1.0.0'
                    
                    // –ì–æ—Ç–æ–≤–∏–º –±–∏–ª–¥-–∞—Ä–≥—É–º–µ–Ω—Ç—ã
                    def buildArgs = [
                        "--build-arg SERVICE=${SERVICE}",
                        "--build-arg PORT=${PORT}",
                        "--build-arg VERSION=${version}",
                        "--build-arg BUILD_NUMBER=${env.BUILD_NUMBER}",
                        "--build-arg GIT_COMMIT=${env.GIT_COMMIT}",
                        "--build-arg NODE_ENV=${NODE_ENV}",
                        "--label version=${version}",
                        "--label build.number=${env.BUILD_NUMBER}",
                        "--label commit=${env.GIT_COMMIT}",
                        "--label service=${SERVICE}",
                        "--label environment=${ENV_TYPE}"
                    ].join(' ')
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
                    echo "Building image: ${DOCKER_BUILD_NAME}"
                    echo "Build args: ${buildArgs}"
                    
                    app = docker.build(
                        "${DOCKER_BUILD_NAME}",
                        "${buildArgs} -f ${dockerfile} ./"
                    )
                    
                    echo "‚úÖ Docker image built successfully"
                }
            }
        }
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ stages –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        stage('Push Docker image') {
            steps {
                script {
                    echo "=== Pushing Docker image ==="
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å registry
                    sh '''
                        echo "Testing Docker registry connection..."
                        docker login ${REGISTRY} -u lumio-su --password-stdin <<< "${DOCKER_PASSWORD}" 2>/dev/null || {
                            echo "‚ö†Ô∏è Could not login to registry, but trying to push anyway"
                        }
                    '''
                    
                    docker.withRegistry("https://${REGISTRY}", 'lumio-su') {
                        // –û—Å–Ω–æ–≤–Ω–æ–π push
                        app.push("${IMAGE_NAME}")
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–≥–∏
                        def packageJson = readJSON file: 'package.json'
                        def version = packageJson.version ?: '1.0.0'
                        
                        // –î–ª—è production –ø—É—à–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–≥–∏
                        if (ENV_TYPE == "production") {
                            app.push("latest")
                            app.push("v${version}")
                            app.push("production-${version}")
                            echo "‚úÖ Pushed additional tags: latest, v${version}, production-${version}"
                        }
                        
                        // –î–ª—è staging
                        if (ENV_TYPE == "staging") {
                            app.push("staging")
                            app.push("staging-${version}")
                        }
                    }
                    
                    echo "‚úÖ Docker image pushed successfully"
                }
            }
        }
        
        stage('Clean local Docker images') {
            steps {
                sh '''
                    echo "=== Cleaning local Docker images ==="
                    
                    # –£–¥–∞–ª—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑
                    docker rmi -f ${DOCKER_BUILD_NAME} 2>/dev/null || true
                    
                    # –£–¥–∞–ª—è–µ–º dangling images
                    docker image prune -f 2>/dev/null || true
                    
                    echo "‚úÖ Local Docker cleanup completed"
                '''
            }
        }
        
        stage('Prepare Kubernetes deployment') {
            steps {
                script {
                    echo "=== Preparing Kubernetes deployment ==="
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è
                    def deployScript = "./apps/${SERVICE}/preparingDeploy.sh"
                    if (!fileExists(deployScript)) {
                        error "‚ùå Deploy script not found: ${deployScript}"
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω executable
                    sh """
                        echo "Checking deploy script..."
                        if [ ! -x "${deployScript}" ]; then
                            echo "Making deploy script executable..."
                            chmod +x ${deployScript}
                        fi
                    """
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç
                    sh """
                        echo "Running deploy script..."
                        ./apps/${SERVICE}/preparingDeploy.sh \\
                            "${REGISTRY_HOSTNAME}" \\
                            "${PROJECT}" \\
                            "${IMAGE_NAME}" \\
                            "${DEPLOYMENT_NAME}" \\
                            "${PORT}" \\
                            "${NAMESPACE}"
                        
                        echo "=== Generated deployment.yaml ==="
                        DEPLOYMENT_FILE="./apps/${SERVICE}/deployment.yaml"
                        
                        if [ -f "\${DEPLOYMENT_FILE}" ]; then
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                            cat "\${DEPLOYMENT_FILE}"
                        else
                            echo "‚ùå deployment.yaml not generated!"
                            exit 1
                        fi
                    """
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    echo "=== Deploying to Kubernetes ==="
                    
                    withKubeConfig([credentialsId: 'prod-kubernetes']) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É
                        sh '''
                            echo "Checking Kubernetes connection..."
                            
                            if ! kubectl cluster-info; then
                                echo "‚ùå Cannot connect to Kubernetes cluster"
                                exit 1
                            fi
                            
                            echo "Kubernetes nodes:"
                            kubectl get nodes --no-headers | wc -l || echo "0"
                        '''
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç
                        sh """
                            echo "Applying deployment to namespace ${NAMESPACE}..."
                            
                            DEPLOYMENT_FILE="./apps/${SERVICE}/deployment.yaml"
                            
                            # Dry-run —Å–Ω–∞—á–∞–ª–∞
                            kubectl apply -f "\${DEPLOYMENT_FILE}" --namespace=${NAMESPACE} --dry-run=client
                            
                            # –ü—Ä–∏–º–µ–Ω—è–µ–º
                            kubectl apply -f "\${DEPLOYMENT_FILE}" --namespace=${NAMESPACE}
                            
                            echo "Watching rollout status..."
                            
                            # –ñ–¥–µ–º rollout —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                            timeout=300
                            interval=5
                            elapsed=0
                            
                            while [ \$elapsed -lt \$timeout ]; do
                                status=\$(kubectl rollout status deployment/${DEPLOYMENT_NAME} \\
                                    --namespace=${NAMESPACE} \\
                                    --timeout=60s 2>&1 || true)
                                
                                if echo "\$status" | grep -q "successfully rolled out"; then
                                    echo "‚úÖ Deployment rolled out successfully"
                                    break
                                fi
                                
                                echo "Waiting for rollout... (\$elapsed/\$timeout seconds)"
                                sleep \$interval
                                elapsed=\$((elapsed + interval))
                            done
                            
                            if [ \$elapsed -ge \$timeout ]; then
                                echo "‚ö†Ô∏è Rollout timeout reached"
                            fi
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                            echo "=== Deployment details ==="
                            kubectl get deployment/${DEPLOYMENT_NAME} \\
                                --namespace=${NAMESPACE} \\
                                -o wide
                            
                            echo "=== Pods status ==="
                            kubectl get pods \\
                                --namespace=${NAMESPACE} \\
                                -l app=${DEPLOYMENT_NAME} \\
                                -o wide
                        """
                    }
                    
                    echo "‚úÖ Kubernetes deployment completed"
                }
            }
        }
        
        stage('Post-deployment verification') {
            steps {
                script {
                    echo "=== Post-deployment verification ==="
                    
                    // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
                    sleep 30
                    
                    withKubeConfig([credentialsId: 'prod-kubernetes']) {
                        sh """
                            echo "Checking deployment health..."
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–æ–¥–æ–≤
                            READY=\$(kubectl get deployment ${DEPLOYMENT_NAME} \\
                                --namespace=${NAMESPACE} \\
                                -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
                            
                            DESIRED=\$(kubectl get deployment ${DEPLOYMENT_NAME} \\
                                --namespace=${NAMESPACE} \\
                                -o jsonpath='{.spec.replicas}' 2>/dev/null || echo "0")
                            
                            echo "Ready replicas: \${READY}/\${DESIRED}"
                            
                            if [ "\${READY}" -eq "\${DESIRED}" ] && [ "\${READY}" -gt "0" ]; then
                                echo "‚úÖ All pods are ready"
                            else
                                echo "‚ö†Ô∏è Not all pods are ready"
                                
                                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è
                                echo "Recent events:"
                                kubectl get events \\
                                    --namespace=${NAMESPACE} \\
                                    --field-selector involvedObject.name=${DEPLOYMENT_NAME} \\
                                    --sort-by='.lastTimestamp' \\
                                    --tail=10 2>/dev/null || true
                            fi
                        """
                    }
                    
                    echo "‚úÖ Post-deployment verification completed"
                }
            }
        }
    }
    
    post {
        always {
            echo "=== Pipeline execution completed ==="
            echo "Job: ${JOB_NAME}"
            echo "Build: ${BUILD_NUMBER}"
            echo "Result: ${currentBuild.result}"
            echo "Duration: ${currentBuild.durationString}"
            echo "Commit: ${GIT_COMMIT}"
            echo "Branch: ${GIT_BRANCH}"
            echo "Image: ${DOCKER_BUILD_NAME}"
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
            archiveArtifacts artifacts: '**/coverage/**/*', allowEmptyArchive: true
            archiveArtifacts artifacts: '**/*.log', allowEmptyArchive: true
            archiveArtifacts artifacts: '**/deployment.yaml', allowEmptyArchive: true
        }
        
        success {
            echo "üéâ Pipeline SUCCESS!"
        }
        
        failure {
            echo "üí• Pipeline FAILED!"
        }
        
        cleanup {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—ç—à –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–∏–ª–¥–∞
            sh '''
                echo "=== Final cleanup ==="
                echo "Preserving cache directories..."
                
                # –û—á–∏—â–∞–µ–º workspace –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫—ç—à
                find . -maxdepth 1 ! -name ".yarn-cache" ! -name ".prisma-cache" ! -name "." -exec rm -rf {} + 2>/dev/null || true
                
                echo "Cleanup completed"
            '''
        }
    }
}